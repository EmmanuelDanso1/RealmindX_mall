{% extends 'index.html' %}
{% block title %}{{ product.name }} - Product Detail{% endblock %}
{% block content %}
<div class="container mt-5">
  <div class="row">
    <!-- Product Image -->
    <div class="col-md-6">
      <img src="{{ url_for('static', filename='uploads/' + product.image_filename) }}" 
           alt="{{ product.name }}" 
           class="img-fluid rounded shadow">
    </div>

    <!-- Product Details -->
    <div class="col-md-6">
      <h2>{{ product.name }}</h2>
      <p class="text-muted">{{ product.description }}</p>

      <!-- Price Display -->
      {% if product.discount_percentage and product.discount_percentage > 0 %}
        <h4 class="text-danger fw-bold">GH₵{{ '%.2f' % product.discounted_price }}</h4>
        <p class="text-muted"><del>GH₵{{ '%.2f' % product.price }}</del></p>
        <span class="badge bg-success">{{ product.discount_percentage }}% OFF</span>
      {% else %}
        <h4 class="text-primary fw-bold">GH₵{{ '%.2f' % product.price }}</h4>
      {% endif %}

      <!-- Stock Status -->
      <div class="mt-2 mb-3">
        {% if product.in_stock %}
          <span class="badge bg-success">In Stock</span>
        {% else %}
          <span class="badge bg-danger">Out of Stock</span>
        {% endif %}
      </div>

      <!-- Add to Cart Form -->
      <form method="POST" id="addToCartForm" class="mt-4">
        <div class="mb-3">
          <label for="quantity" class="form-label fw-bold">Quantity</label>
          <input type="number" 
                 name="quantity" 
                 id="quantity" 
                 class="form-control" 
                 min="1" 
                 value="1" 
                 style="max-width: 150px;"
                 required>
        </div>

        <!-- Two Button Options -->
        <div class="d-flex gap-2 flex-wrap mb-4">
          <!-- Add to Cart and Stay on Current Page -->
          <button type="submit" 
                  class="btn btn-primary px-4"
                  formaction="{{ url_for('cart.add_quantity', product_id=product.id) }}"
                  name="redirect_to"
                  value="stay"
                  {% if not product.in_stock %}disabled{% endif %}>
            <i class="bi bi-cart-plus"></i> Add to Cart
          </button>

          <!-- Buy Now (Go to Checkout) -->
          <button type="submit" 
                  class="btn btn-success px-4"
                  formaction="{{ url_for('cart.add_quantity', product_id=product.id) }}"
                  name="redirect_to"
                  value="checkout"
                  {% if not product.in_stock %}disabled{% endif %}>
            <i class="bi bi-lightning-fill"></i> Buy Now
          </button>
        </div>

        <!-- Optional: Link to continue shopping -->
        <div class="mb-3">
          <a href="{{ url_for('main.shop') }}" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-left"></i> Continue Shopping
          </a>
        </div>
      </form>

      <!-- Average Rating -->
      <div class="mt-4">
        <h5>Ratings</h5>
        {% if product.ratings %}
          {% set avg_rating = (product.ratings | map(attribute='rating') | list | sum) / (product.ratings|length) %}
          <p class="text-warning">
            {% for i in range(1, 6) %}
              {% if i <= avg_rating %}
                <span>&#9733;</span>
              {% else %}
                <span class="text-secondary">&#9733;</span>
              {% endif %}
            {% endfor %}
            <small>({{ '%.1f' % avg_rating }} / 5 based on {{ product.ratings|length }} reviews)</small>
          </p>
        {% else %}
          <p class="text-muted">No ratings yet</p>
        {% endif %}

        <!-- User Rating -->
        {% if current_user.is_authenticated %}
          {% if user_rating %}
            <p class="text-muted">You rated this product: {{ user_rating.rating }}/5</p>
          {% else %}
            <form method="POST" action="{{ url_for('main.rate_product', product_id=product.id) }}">
              <div class="rating mb-2">
                {% for i in range(5, 0, -1) %}
                  <input type="radio" name="rating" value="{{ i }}" id="star{{ i }}">
                  <label for="star{{ i }}">★</label>
                {% endfor %}
              </div>
              <button type="submit" class="btn btn-sm btn-primary">Submit Rating</button>
            </form>
          {% endif %}
        {% else %}
          <p><a href="{{ url_for('auth.login') }}">Log in</a> to rate this product.</p>
        {% endif %}
      </div>
    </div>
  </div>
  <br>
</div>

<style>
.rating {
  display: inline-flex;
  flex-direction: row-reverse;
  justify-content: flex-end;
}

.rating label {
  font-size: 1.4rem;
  cursor: pointer;
  color: #ddd;
  transition: color 0.2s;
}

.rating input {
  display: none;
}

.rating label:hover,
.rating label:hover ~ label,
.rating input:checked ~ label {
  color: gold;
}
</style>
{% endblock %}