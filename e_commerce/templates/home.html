{% extends "index.html" %}

{% block title %}Welcome | RealmindXEduMall{% endblock %}

{% block content %}
<div class="container my-5">
  {% if not current_user.is_authenticated %}
    <h2 class="text-center mb-4">Latest Products</h2>

    {% if products.items %}
      <div class="row">
        {% for product in products.items %}
        <div class="col-md-4 mb-4">
          <div class="card h-100 shadow-sm border-0">
            <div class="position-relative" style="height: 250px;">
              <img 
                src="{{ url_for('static', filename='uploads/' ~ product.image_filename) }}" 
                class="card-img-top" 
                alt="{{ product.name }}" 
                style="height: 100%; object-fit: cover;">
              {% if not product.in_stock %}
              <div class="position-absolute top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center"
                   style="background-color: rgba(0, 0, 0, 0.4); z-index: 10;">
                <span class="text-white fw-bold" style="font-size: 2rem;">Out of Stock</span>
              </div>
              {% endif %}
            </div>

            <div class="card-body">
              <h5 class="card-title">{{ product.name }}</h5>
              <p class="card-text">{{ product.description[:100] }}{% if product.description|length > 100 %}...{% endif %}</p>

              {% if product.author %}
                <p class="mb-1"><strong>Author:</strong> {{ product.author }}</p>
              {% endif %}
              {% if product.subject %}
                <p class="mb-1"><strong>Subject:</strong> {{ product.subject }}</p>
              {% endif %}
              {% if product.grade %}
                <p class="mb-1"><strong>Grade:</strong> {{ product.grade }}</p>
              {% endif %}
              {% if product.level %}
                <p class="mb-1"><strong>Level:</strong> {{ product.level }}</p>
              {% endif %}
              {% if product.brand %}
                <p class="mb-1"><strong>Brand:</strong> {{ product.brand }}</p>
              {% endif %}

              <p class="text-primary fw-bold">GH₵{{ '%.2f'|format(product.price) }}</p>

              {% if product.ratings %}
                {% set avg_rating = (product.ratings | map(attribute='rating') | list | sum) / product.ratings|length %}
                <div class="mb-2">
                  {% for i in range(1, 6) %}
                    {% if i <= avg_rating %}
                      <span class="text-warning">&#9733;</span>
                    {% else %}
                      <span class="text-secondary">&#9733;</span>
                    {% endif %}
                  {% endfor %}
                  <small class="text-muted">({{ '%.1f' % avg_rating }} / 5)</small>
                </div>
              {% else %}
                <small class="text-muted d-block mb-2">No rating</small>
              {% endif %}

              {% if product.in_stock %}
                <span class="badge bg-success mb-2">In Stock</span>
              {% else %}
                <span class="badge bg-danger mb-2">Out of Stock</span>
              {% endif %}

              <br>
              {% if product.in_stock %}
                <a href="{{ url_for('cart.add_quantity', product_id=product.id) }}" class="btn btn-outline-dark btn-sm mt-2">Add to cart</a>
              {% else %}
                <button class="btn btn-outline-dark btn-sm mt-2" disabled>Add to cart</button>
              {% endif %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Pagination shown ONLY if products exist -->
      <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center mt-4">
          {% if products.has_prev %}
            <li class="page-item">
              <a class="page-link" href="{{ url_for('main.home', page=products.prev_num) }}">Previous</a>
            </li>
          {% else %}
            <li class="page-item disabled">
              <span class="page-link">Previous</span>
            </li>
          {% endif %}

          {% for p in products.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
            {% if p %}
              <li class="page-item {% if p == products.page %}active{% endif %}">
                <a class="page-link" href="{{ url_for('main.home', page=p) }}">{{ p }}</a>
              </li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">…</span></li>
            {% endif %}
          {% endfor %}

          {% if products.has_next %}
            <li class="page-item">
              <a class="page-link" href="{{ url_for('main.home', page=products.next_num) }}">Next</a>
            </li>
          {% else %}
            <li class="page-item disabled">
              <span class="page-link">Next</span>
            </li>
          {% endif %}
        </ul>
      </nav>
    {% else %}
      <div class="alert alert-warning text-center">No products available at the moment.</div>
    {% endif %}
  {% else %}
    <div class="alert alert-info text-center">
      Welcome, {{ current_user.username }}. You can view and rate your <a href="{{ url_for('main.purchased_products') }}">purchased products here</a>.
    </div>
  {% endif %}
</div>
{% endblock %}
