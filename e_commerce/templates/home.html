{% extends "index.html" %}

{% block title %}Welcome | RealmindXEduMall{% endblock %}

{% block content %}
<div class="container my-5">
  {% if not current_user.is_authenticated %}
    <h2 class="text-center mb-4">Latest Products</h2>
    <div class="row">
      {% for product in products %}
      <div class="col-md-4 mb-4">
        <div class="card h-100 shadow-sm border-0">

          <!-- Product Image Wrapper with Overlay -->
          <div class="position-relative" style="height: 250px;">
            <img 
              src="{{ url_for('static', filename='uploads/' ~ product.image_filename) }}" 
              class="card-img-top" 
              alt="{{ product.name }}" 
              style="height: 100%; object-fit: cover;"
            >

            {% if not product.in_stock %}
            <!-- Out of Stock Overlay -->
            <div class="position-absolute top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center"
                 style="background-color: rgba(0, 0, 0, 0.4); z-index: 10;">
              <span class="text-white fw-bold" style="font-size: 2rem;">Out of Stock</span>
            </div>
            {% endif %}
          </div>

          <!-- Product Details -->
          <div class="card-body">
            <h5 class="card-title">{{ product.name }}</h5>

            <p class="card-text">
              {{ product.description[:100] }}
              {% if product.description|length > 100 %}...{% endif %}
            </p>

            <!-- Product Price -->
            <p class="text-primary fw-bold">GH₵{{ '%.2f'|format(product.price) }}</p>

            <!-- ⭐ Always Show Rating Section (even if no rating) -->
            {% if product.ratings %}
              {% set avg_rating = (product.ratings | map(attribute='rating') | list | sum) / product.ratings|length %}
              <div class="mb-2">
                {% for i in range(1, 6) %}
                  {% if i <= avg_rating %}
                    <span class="text-warning">&#9733;</span>
                  {% else %}
                    <span class="text-secondary">&#9733;</span>
                  {% endif %}
                {% endfor %}
                <small class="text-muted">({{ '%.1f' % avg_rating }} / 5)</small>
              </div>
            {% else %}
              <small class="text-muted d-block mb-2">No rating</small>
            {% endif %}

            <!-- Stock Status Badge -->
            {% if product.in_stock %}
              <span class="badge bg-success mb-2">In Stock</span>
            {% else %}
              <span class="badge bg-danger mb-2">Out of Stock</span>
            {% endif %}

            <!-- Add to Cart Button -->
            <br>
            {% if product.in_stock %}
              <a href="{{ url_for('cart.add_quantity', product_id=product.id) }}" class="btn btn-outline-dark btn-sm mt-2">Add to cart</a>
            {% else %}
              <button class="btn btn-outline-dark btn-sm mt-2" disabled>Add to cart</button>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-info text-center">
      Welcome, {{ current_user.username }}. You can view and rate your <a href="{{ url_for('main.purchased_products') }}">purchased products here</a>.
    </div>
  {% endif %}
</div>
{% endblock %}
